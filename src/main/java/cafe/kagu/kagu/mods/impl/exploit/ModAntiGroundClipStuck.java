/**
 * 
 */
package cafe.kagu.kagu.mods.impl.exploit;

import cafe.kagu.kagu.eventBus.EventHandler;
import cafe.kagu.kagu.eventBus.Handler;
import cafe.kagu.kagu.eventBus.impl.EventPacketReceive;
import cafe.kagu.kagu.eventBus.impl.EventPacketSend;
import cafe.kagu.kagu.mods.Module;
import cafe.kagu.kagu.utils.MovementUtils;
import net.minecraft.client.entity.EntityPlayerSP;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;

/**
 * @author DistastefulBannock
 *
 */
public class ModAntiGroundClipStuck extends Module {
	
	public ModAntiGroundClipStuck() {
		super("AntiGroundClipStuck", Category.EXPLOIT);
	}
	
	@EventHandler
	private Handler<EventPacketReceive> onPacketReceive = e -> {
		if (e.isPost() || !(e.getPacket() instanceof S08PacketPlayerPosLook) || e.isCanceled()) {
			return;
		}
		EntityPlayerSP thePlayer = mc.thePlayer;
		S08PacketPlayerPosLook s08 = (S08PacketPlayerPosLook)e.getPacket();
		double offsetX = Math.abs(thePlayer.posX - s08.getX());
		double offsetY = Math.abs(thePlayer.posY - s08.getY());
		double offsetZ = Math.abs(thePlayer.posZ - s08.getZ());
		if (!(offsetX == 0 && offsetY <= 1 && offsetZ == 0))
			return;
		if (!(MovementUtils.isTrueOnGround() && MovementUtils.isTrueOnGround(offsetY)))
			return;
		double offset = 0;
		for (double d = 1.5; d > 0; d -= 0.05) {
			if (MovementUtils.isTrueOnGround(-d))
				break;
			offset = d;
		}
		thePlayer.setPosition(s08.getX(), s08.getY() + offset, s08.getZ());
		thePlayer.motionX = 0;
		thePlayer.motionZ = 0;
		e.cancel();
	};
	
}
